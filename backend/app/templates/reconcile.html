{% extends "layout.html" %}

{% block title %}Reconcile - Inventory AI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-check-circle"></i> Reconciliation</h1>
        <p class="lead">Run daily reconciliation and view/download anomaly reports</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-play-circle"></i> Run Reconciliation</h5>
            </div>
            <div class="card-body">
                <form id="reconcile-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="date" class="form-control" id="reconcile-date" required>
                                <label for="reconcile-date">Date to Reconcile</label>
                            </div>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-sync"></i> Run Reconciliation
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="loadAnomalies()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                        </div>
                    </div>
                </form>
                <div id="reconcile-result" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Today's Summary</h5>
            </div>
            <div class="card-body">
                <div id="anomaly-summary">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-exclamation-triangle"></i> Anomalies</h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary btn-sm" onclick="filterAnomalies('all')">All</button>
                    <button class="btn btn-outline-danger btn-sm" onclick="filterAnomalies('high')">High</button>
                    <button class="btn btn-outline-warning btn-sm" onclick="filterAnomalies('med')">Medium</button>
                    <button class="btn btn-outline-info btn-sm" onclick="filterAnomalies('low')">Low</button>
                </div>
            </div>
            <div class="card-body">
                <div id="anomalies-table">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-download"></i> Download Reports</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="downloadReport('csv')">
                        <i class="fas fa-file-csv"></i> Download CSV Report
                    </button>
                    <button class="btn btn-danger" onclick="downloadReport('pdf')">
                        <i class="fas fa-file-pdf"></i> Download PDF Report
                    </button>
                    <button class="btn btn-info" onclick="downloadInventoryReport()">
                        <i class="fas fa-list"></i> Download Current Inventory
                    </button>
                </div>
                <div id="download-status" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="markAllResolved()">
                        <i class="fas fa-check"></i> Mark All as Resolved
                    </button>
                    <button class="btn btn-outline-warning" onclick="exportToWMS()">
                        <i class="fas fa-external-link-alt"></i> Export to WMS
                    </button>
                    <button class="btn btn-outline-info" onclick="generateLabels()">
                        <i class="fas fa-tags"></i> Generate Labels
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Anomaly Details Modal -->
<div class="modal fade" id="anomalyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Anomaly Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="anomaly-details"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="resolveAnomaly()">Mark as Resolved</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentAnomalies = [];
    let currentAnomalyId = null;

    // Set default date to today
    document.getElementById('reconcile-date').value = new Date().toISOString().split('T')[0];

    // Reconciliation form handler
    document.getElementById('reconcile-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const date = document.getElementById('reconcile-date').value;
        const resultContainer = document.getElementById('reconcile-result');
        const submitButton = this.querySelector('button[type="submit"]');
        
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
        submitButton.disabled = true;
        
        try {
            const response = await fetch(`/api/reconcile/run?date=${date}`, {
                method: 'POST',
                headers: {'Authorization': `Bearer ${getApiKey()}`}
            });
            
            const data = await response.json();
            
            resultContainer.innerHTML = `
                <div class="alert alert-success">
                    <h6>Reconciliation Completed!</h6>
                    <ul class="mb-0">
                        <li>Total Anomalies: ${data.reconciliation.total_anomalies}</li>
                        <li>Orders Checked: ${data.reconciliation.orders_checked}</li>
                        <li>Snapshots Processed: ${data.reconciliation.snapshots_processed}</li>
                        <li>Bins Scanned: ${data.reconciliation.bins_scanned}</li>
                    </ul>
                    ${data.reports.csv_url ? `<div class="mt-2">
                        <a href="${data.reports.csv_url}" class="btn btn-sm btn-outline-success">CSV Report</a>
                        <a href="${data.reports.pdf_url}" class="btn btn-sm btn-outline-danger">PDF Report</a>
                    </div>` : ''}
                </div>
            `;
            
            // Refresh data
            loadAnomalies();
            loadAnomalySummary();
            
        } catch (error) {
            resultContainer.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        } finally {
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        }
    });

    async function loadAnomalies() {
        const container = document.getElementById('anomalies-table');
        container.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
        
        try {
            const date = document.getElementById('reconcile-date').value;
            const response = await fetch(`/api/reconcile/anomalies?date=${date}`, {
                headers: {'Authorization': `Bearer ${getApiKey()}`}
            });
            
            currentAnomalies = await response.json();
            displayAnomalies(currentAnomalies);
            
        } catch (error) {
            container.innerHTML = `<div class="alert alert-danger">Error loading anomalies: ${error.message}</div>`;
        }
    }

    function displayAnomalies(anomalies) {
        const container = document.getElementById('anomalies-table');
        
        if (anomalies.length === 0) {
            container.innerHTML = `
                <div class="text-center text-success">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <h5>No Anomalies Found!</h5>
                    <p>Everything looks good for this date.</p>
                </div>
            `;
            return;
        }

        const table = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Bin</th>
                            <th>Item</th>
                            <th>Order</th>
                            <th>Description</th>
                            <th>Time</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${anomalies.map(anomaly => `
                            <tr class="anomaly-row" data-severity="${anomaly.severity}">
                                <td>
                                    <span class="badge bg-${getTypeColor(anomaly.type)}">${anomaly.type}</span>
                                </td>
                                <td>
                                    <span class="badge bg-${getSeverityColor(anomaly.severity)}">${anomaly.severity}</span>
                                </td>
                                <td>${anomaly.bin_id || '-'}</td>
                                <td>${anomaly.item_id || '-'}</td>
                                <td>${anomaly.order_id || '-'}</td>
                                <td class="small">${anomaly.detail.substring(0, 50)}${anomaly.detail.length > 50 ? '...' : ''}</td>
                                <td class="small">${new Date(anomaly.ts).toLocaleTimeString()}</td>
                                <td>
                                    <span class="badge bg-${anomaly.status === 'open' ? 'warning' : 'success'}">${anomaly.status}</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewAnomalyDetails(${anomaly.id})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        container.innerHTML = table;
    }

    async function loadAnomalySummary() {
        const container = document.getElementById('anomaly-summary');
        
        try {
            const date = document.getElementById('reconcile-date').value;
            const response = await fetch(`/api/reconcile/anomalies/summary?date=${date}`, {
                headers: {'Authorization': `Bearer ${getApiKey()}`}
            });
            
            const data = await response.json();
            
            const html = `
                <div class="text-center mb-3">
                    <h3 class="text-${data.total_anomalies === 0 ? 'success' : 'warning'}">${data.total_anomalies}</h3>
                    <p class="text-muted">Total Anomalies</p>
                </div>
                
                ${data.total_anomalies > 0 ? `
                    <div class="mb-3">
                        <h6>By Severity:</h6>
                        ${Object.entries(data.by_severity).map(([severity, count]) => `
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-${getSeverityColor(severity)}">${severity}</span>
                                <span>${count}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div>
                        <h6>By Type:</h6>
                        ${Object.entries(data.by_type).map(([type, count]) => `
                            <div class="d-flex justify-content-between small">
                                <span>${type}</span>
                                <span>${count}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p class="text-success text-center">🎉 All Clear!</p>'}
            `;
            
            container.innerHTML = html;
            
        } catch (error) {
            container.innerHTML = `<div class="alert alert-danger small">Error: ${error.message}</div>`;
        }
    }

    function filterAnomalies(severity) {
        const rows = document.querySelectorAll('.anomaly-row');
        rows.forEach(row => {
            if (severity === 'all' || row.dataset.severity === severity) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    async function viewAnomalyDetails(anomalyId) {
        currentAnomalyId = anomalyId;
        const anomaly = currentAnomalies.find(a => a.id === anomalyId);
        
        if (!anomaly) return;
        
        const details = `
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr><td><strong>ID:</strong></td><td>${anomaly.id}</td></tr>
                        <tr><td><strong>Type:</strong></td><td><span class="badge bg-${getTypeColor(anomaly.type)}">${anomaly.type}</span></td></tr>
                        <tr><td><strong>Severity:</strong></td><td><span class="badge bg-${getSeverityColor(anomaly.severity)}">${anomaly.severity}</span></td></tr>
                        <tr><td><strong>Status:</strong></td><td><span class="badge bg-${anomaly.status === 'open' ? 'warning' : 'success'}">${anomaly.status}</span></td></tr>
                        <tr><td><strong>Time:</strong></td><td>${new Date(anomaly.ts).toLocaleString()}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr><td><strong>Bin ID:</strong></td><td>${anomaly.bin_id || 'N/A'}</td></tr>
                        <tr><td><strong>Item ID:</strong></td><td>${anomaly.item_id || 'N/A'}</td></tr>
                        <tr><td><strong>Order ID:</strong></td><td>${anomaly.order_id || 'N/A'}</td></tr>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <h6>Description:</h6>
                    <p class="bg-light p-3 rounded">${anomaly.detail}</p>
                </div>
            </div>
        `;
        
        document.getElementById('anomaly-details').innerHTML = details;
        new bootstrap.Modal(document.getElementById('anomalyModal')).show();
    }

    async function resolveAnomaly() {
        if (!currentAnomalyId) return;
        
        try {
            const response = await fetch(`/api/reconcile/anomalies/${currentAnomalyId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getApiKey()}`
                },
                body: JSON.stringify({status: 'closed'})
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('anomalyModal')).hide();
                loadAnomalies();
                loadAnomalySummary();
            }
        } catch (error) {
            alert(`Error resolving anomaly: ${error.message}`);
        }
    }

    async function downloadReport(format) {
        const statusContainer = document.getElementById('download-status');
        statusContainer.innerHTML = '<div class="text-info">Generating report...</div>';
        
        try {
            const date = document.getElementById('reconcile-date').value;
            const response = await fetch(`/api/reconcile/reports/generate?date=${date}`, {
                headers: {'Authorization': `Bearer ${getApiKey()}`}
            });
            
            const data = await response.json();
            
            if (format === 'csv' && data.reports.csv_url) {
                window.open(data.reports.csv_url, '_blank');
            } else if (format === 'pdf' && data.reports.pdf_url) {
                window.open(data.reports.pdf_url, '_blank');
            }
            
            statusContainer.innerHTML = '<div class="text-success">Report downloaded!</div>';
            setTimeout(() => statusContainer.innerHTML = '', 3000);
            
        } catch (error) {
            statusContainer.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
        }
    }

    async function downloadInventoryReport() {
        try {
            const response = await fetch('/api/reconcile/reports/inventory', {
                headers: {'Authorization': `Bearer ${getApiKey()}`}
            });
            
            const data = await response.json();
            
            if (data.reports.csv_url) {
                window.open(data.reports.csv_url, '_blank');
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // Helper functions
    function getTypeColor(type) {
        const colors = {
            'missing': 'danger',
            'misplaced': 'warning', 
            'orphan': 'info',
            'stale_staging': 'danger',
            'unshipped': 'warning'
        };
        return colors[type] || 'secondary';
    }

    function getSeverityColor(severity) {
        const colors = {
            'high': 'danger',
            'med': 'warning',
            'low': 'info'
        };
        return colors[severity] || 'secondary';
    }

    function getApiKey() {
        return window.API_KEY || 'changeme-supersecret';
    }

    // Placeholder functions
    function markAllResolved() {
        if (confirm('Mark all open anomalies as resolved?')) {
            alert('Feature not yet implemented');
        }
    }

    function exportToWMS() {
        alert('WMS export feature not yet implemented');
    }

    function generateLabels() {
        alert('Label generation feature available in main app');
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAnomalies();
        loadAnomalySummary();
    });
</script>
{% endblock %}